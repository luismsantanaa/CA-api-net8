name: CI - Build and Test

# Triggers del workflow
on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch: # Permite ejecuciÃ³n manual

env:
  DOTNET_VERSION: '8.0.x'
  CONFIGURATION: Release

jobs:
  # ===================================
  # Job 1: Build y Test
  # ===================================
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    # Checkout del cÃ³digo
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Para SonarCloud y versionado

    # Setup .NET
    - name: ðŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # Restore dependencies
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore

    # Build
    - name: ðŸ”¨ Build solution
      run: dotnet build --configuration ${{ env.CONFIGURATION }} --no-restore

    # Run tests
    - name: ðŸ§ª Run tests
      run: dotnet test --configuration ${{ env.CONFIGURATION }} --no-build --verbosity normal --collect:"XPlat Code Coverage" --results-directory ./coverage

    # Upload test results
    - name: ðŸ“Š Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: '**/TestResults/**/*'
        
    # Upload coverage to Codecov (opcional)
    - name: ðŸ“ˆ Upload coverage to Codecov
      if: success()
      uses: codecov/codecov-action@v4
      with:
        directory: ./coverage
        fail_ci_if_error: false
        verbose: true

  # ===================================
  # Job 2: Code Quality Analysis
  # ===================================
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # AnÃ¡lisis de cÃ³digo con .NET analyzers
    - name: ðŸ” Run code analysis
      run: dotnet build --configuration ${{ env.CONFIGURATION }} /p:EnforceCodeStyleInBuild=true /p:TreatWarningsAsErrors=false

  # ===================================
  # Job 3: Build SQL Database Project
  # ===================================
  build-database:
    name: Build SQL Database Project
    runs-on: windows-latest # SSDT solo funciona en Windows
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    # Setup MSBuild (para SQL Server Database Projects)
    - name: ðŸ”§ Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    # Build SQL Database Project
    - name: ðŸ”¨ Build SQL Database Project
      run: msbuild database/CleanArchitectureDb/CleanArchitectureDb.sqlproj /p:Configuration=Release /v:minimal

    # Upload .dacpac artifact
    - name: ðŸ“¦ Upload .dacpac artifact
      uses: actions/upload-artifact@v4
      with:
        name: database-dacpac
        path: database/CleanArchitectureDb/bin/Release/*.dacpac
        retention-days: 7

  # ===================================
  # Job 4: Security Scan (opcional)
  # ===================================
  security-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' # Solo en push, no en PR
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    # Escaneo de vulnerabilidades
    - name: ðŸ›¡ï¸ Run security scan
      run: |
        dotnet restore
        dotnet list package --vulnerable --include-transitive 2>&1 | tee security-scan.txt
        
    - name: ðŸ“Š Upload security scan results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-scan
        path: security-scan.txt

  # ===================================
  # Job 5: Build Summary
  # ===================================
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-and-test, code-quality, build-database]
    if: always()
    
    steps:
    - name: ðŸ“‹ Generate build summary
      run: |
        echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Jobs Status:" >> $GITHUB_STEP_SUMMARY
        echo "- Build and Test: ${{ needs.build-and-test.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Database Build: ${{ needs.build-database.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Build Information:" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        echo "- Workflow: ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY

